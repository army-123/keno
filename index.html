<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ziii Game</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body {
        margin: 0;
        background: #0d0d0d;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
    }

    h1 {
        margin-top: 15px;
        color: #ffcc00;
        text-shadow: 0 0 10px #ffcc00;
    }

    #walletBox {
        font-size: 18px;
        margin-top: 5px;
        color: #00f2ff;
        font-weight: bold;
    }

    /* JOIN BUTTONS */
    .joinButton {
        display: block;
        margin: 12px auto;
        padding: 14px 25px;
        width: 240px;
        font-size: 22px;
        background: #ffcc00;
        color: black;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
    }

    /* WAITING TEXT GLOW */
    #waitingBox {
        margin-top: 15px;
        font-size: 22px;
        font-weight: bold;
        color: #ffcc00;
        text-shadow: 0 0 15px #ffcc00;
        display: none;
        animation: glow 1.2s infinite alternate;
    }

    @keyframes glow {
        from { text-shadow: 0 0 8px #ffcc00; opacity: 0.7; }
        to { text-shadow: 0 0 22px #ffee88; opacity: 1; }
    }

    /* NUMBER GRID */
    #numberGrid {
        display: none;
        grid-template-columns: repeat(10, 1fr);
        gap: 8px;
        padding: 20px;
        max-width: 600px;
        margin: auto;
    }

    .num {
        padding: 12px;
        background: #1e1e1e;
        border: 1px solid #444;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .num.selected {
        background: #ffd369;
        color: black;
        box-shadow: 0 0 8px #ffdd88;
    }

    .num.hit {
        background: #00ff44;
        color: black;
        box-shadow: 0 0 10px #00ff88;
    }

    #submitBtn {
        display: none;
        padding: 12px 25px;
        font-size: 20px;
        margin: 10px;
        border-radius: 10px;
        background: #ffcc00;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }

    #countdown {
        margin-top: 10px;
        font-size: 28px;
        color: #00eaff;
        font-weight: bold;
        text-shadow: 0 0 12px #00eaff;
        display: none;
    }

    #results {
        margin-top: 20px;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        width: 85%;
        margin-left: auto;
        margin-right: auto;
        border-radius: 10px;
        font-size: 18px;
    }
</style>
</head>

<body>

<h1>Ziii Game</h1>
<div id="walletBox">Wallet: Loading...</div>

<!-- JOIN BUTTONS -->
<div id="joinContainer">
    <button class="joinButton" onclick="selectEntry(10)">Join With 10</button>
    <button class="joinButton" onclick="selectEntry(20)">Join With 20</button>
    <button class="joinButton" onclick="selectEntry(50)">Join With 50</button>
</div>

<div id="waitingBox">✨ Waiting for players… ✨</div>
<div id="countdown"></div>

<div id="numberGrid"></div>

<button id="submitBtn">Submit Numbers</button>

<div id="results"></div>


<script>
/* ===========================
   SUPABASE INIT
=========================== */
const db = supabase.createClient(
    "https://vdhuexwgplylprgpddoq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkaHVleHdncGx5bHByZ3BkZG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzI3MzgsImV4cCI6MjA4MDE0ODczOH0.oAtftTGawGDSTSpvzZQY_TCjn494tGQ2dn6nGwlzYfc"
);

let username = localStorage.getItem("ziii_user");
let entryAmount = null;
let playerCount = 0;
let countdownStarted = false;


/* ===========================
   LOAD WALLET
=========================== */
async function loadWallet() {
    let { data } = await db
        .from("players")
        .select("wallet")
        .eq("username", username)
        .maybeSingle();

    document.getElementById("walletBox").innerText =
        "Wallet: " + (data?.wallet ?? 0) + " coins";
}
loadWallet();


/* ===========================
   USER SELECTS ENTRY
=========================== */
function selectEntry(amount) {
    entryAmount = amount;
    localStorage.setItem("ziii_amount", amount);

    // Hide join buttons
    document.getElementById("joinContainer").style.display = "none";

    // Show number grid + submit button
    document.getElementById("numberGrid").style.display = "grid";
    document.getElementById("submitBtn").style.display = "block";

    buildGrid();
}


/* ===========================
   NUMBER GRID
=========================== */
let selected = [];

function buildGrid() {
    const grid = document.getElementById("numberGrid");
    grid.innerHTML = "";

    for (let i = 1; i <= 100; i++) {
        const div = document.createElement("div");
        div.className = "num";
        div.innerText = i;

        div.onclick = () => {
            if (selected.includes(i)) {
                selected = selected.filter(n => n !== i);
                div.classList.remove("selected");
            } else if (selected.length < 5) {
                selected.push(i);
                div.classList.add("selected");
            }
        };

        grid.appendChild(div);
    }
}


/* ===========================
   SUBMIT NUMBERS
=========================== */
document.getElementById("submitBtn").onclick = async () => {
    if (selected.length !== 5) return alert("Select 5 numbers!");

    document.getElementById("waitingBox").style.display = "block";

    await db.from("game_entries").insert([{
        username,
        entry: entryAmount,
        numbers: selected,
        status: "waiting"
    }]);
};


/* ===========================
   REALTIME PLAYER CHECK
=========================== */
db.channel("players_watch")
    .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "game_entries" },
        async () => {
            let { data } = await db
                .from("game_entries")
                .select("*")
                .eq("entry", entryAmount)
                .eq("status", "waiting");

            playerCount = data.length;

            if (playerCount >= 2 && !countdownStarted) {
                countdownStarted = true;
                startCountdown();
            }
        }
    )
    .subscribe();


/* ===========================
   COUNTDOWN
=========================== */
function startCountdown() {
    let box = document.getElementById("countdown");
    box.style.display = "block";

    let t = 10;

    let interval = setInterval(() => {
        box.innerText = t + "s";
        t--;

        if (t < 0) {
            clearInterval(interval);
            revealResults();
        }
    }, 1000);
}


/* ===========================
   REVEAL RESULTS
=========================== */
async function revealResults() {
    document.getElementById("waitingBox").style.display = "none";

    let draw = [];
    while (draw.length < 20) {
        let n = Math.floor(Math.random() * 100) + 1;
        if (!draw.includes(n)) draw.push(n);
    }

    let hits = selected.filter(n => draw.includes(n));

    hits.forEach(n => {
        let box = [...document.querySelectorAll(".num")]
            .find(x => Number(x.innerText) === n);
        box?.classList.add("hit");
    });

    let reward = 0;
    if (hits.length === 3) reward = 10;
    if (hits.length === 4) reward = 20;
    if (hits.length === 5) reward = 50;

    if (reward > 0) {
        await db.rpc("add_wallet", {
            user: username,
            amount: reward
        });
        loadWallet();
    }

    document.getElementById("results").innerHTML = `
        Drawn: ${draw.join(", ")}<br>
        Hits: <b>${hits.length}</b><br>
        Reward: <b>${reward} coins</b>
    `;

    await db.from("game_entries").delete().eq("entry", entryAmount);
}
</script>

</body>
</html>
