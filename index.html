<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zii Game — Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: #0c0c0c;
            font-family: Arial, sans-serif;
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .btn {
            background: #0a84ff;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            margin: 10px;
            cursor: pointer;
        }
        .btn:hover { opacity: 0.8; }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            grid-gap: 8px;
            justify-content: center;
            margin-top: 20px;
        }
        .num {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }
        .num.selected {
            background: #0a84ff;
        }
        #countdownBox {
            font-size: 32px;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>

<body>

<h1>Zii Game — Multiplayer (Submit & 60s)</h1>

<div id="loginScreen">
    <h2>Choose entry amount to join</h2>
    <button class="btn" onclick="joinGame(10)">A — Play with 10</button>
    <button class="btn" onclick="joinGame(20)">B — Play with 20</button>
    <button class="btn" onclick="joinGame(50)">C — Play with 50</button>
</div>

<div id="gameScreen" style="display:none;">
    <h2>Select 5 Numbers</h2>
    <div class="number-grid" id="numGrid"></div>

    <button class="btn" onclick="submitNumbers()">Submit Numbers</button>

    <div id="countdownBox"></div>

    <h2>Drawn Numbers</h2>
    <div id="results"></div>

    <h2>Leaderboard</h2>
    <div id="leaderboard"></div>
</div>

<script>
/* -------------------------
   SUPABASE INITIALIZATION
-------------------------- */

const SUPABASE_URL = "https://vdhuexwgplylprgpddoq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkaHVleHdncGx5bHByZ3BkZG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzI3MzgsImV4cCI6MjA4MDE0ODczOH0.oAtftTGawGDSTSpvzZQY_TCjn494tGQ2dn6nGwlzYfc";

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* -------------------------
   GLOBALS
-------------------------- */
let username = "User" + Math.floor(Math.random() * 9999);
let pickedNumbers = [];
let entryAmount = 0;

/* -------------------------
   BUILD NUMBER GRID (1–50)
-------------------------- */
function buildGrid() {
    const grid = document.getElementById("numGrid");
    grid.innerHTML = "";
    for (let i = 1; i <= 50; i++) {
        let div = document.createElement("div");
        div.className = "num";
        div.textContent = i;
        div.onclick = () => toggleNum(i, div);
        grid.appendChild(div);
    }
}
buildGrid();

function toggleNum(n, div) {
    if (pickedNumbers.includes(n)) {
        pickedNumbers = pickedNumbers.filter(x => x !== n);
        div.classList.remove("selected");
    } else {
        if (pickedNumbers.length >= 5) return;
        pickedNumbers.push(n);
        div.classList.add("selected");
    }
}

/* -------------------------
   JOIN GAME
-------------------------- */
async function joinGame(amount) {
    entryAmount = amount;

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "block";

    await db.from("players").insert({
        username,
        entry: amount,
        numbers: [],
        ready: false
    });

    listenGameState();
}

/* -------------------------
   SUBMIT NUMBERS
-------------------------- */
async function submitNumbers() {
    if (pickedNumbers.length !== 5) {
        alert("Pick exactly 5 numbers!");
        return;
    }

    await db.from("players")
        .update({ numbers: pickedNumbers, ready: true })
        .eq("username", username);

    alert("Numbers submitted — waiting for others…");
}

/* -------------------------
   LISTEN FOR GAME STATE
-------------------------- */
function listenGameState() {
    db.channel("gamestate")
        .on("postgres_changes", { event: "*", schema: "public", table: "game_state" }, payload => {
            const state = payload.new;
            handleState(state);
        })
        .subscribe();
}

/* -------------------------
   HANDLE GAME STATE
-------------------------- */
function handleState(state) {
    if (!state) return;

    if (state.countdown > 0) {
        document.getElementById("countdownBox").innerHTML =
            "Game starts in: " + state.countdown + "s";
    }

    if (state.status === "drawing") {
        document.getElementById("results").innerHTML =
            "Drawn Numbers: " + JSON.stringify(state.drawn_numbers);
    }
}

</script>

</body>
</html>
