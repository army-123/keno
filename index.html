<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zii Game üéØ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0d0d0d;
      color: white;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    h1 {
      margin-top: 25px;
      color: #ffdd55;
      text-shadow: 0 0 12px #ffdd55;
    }
    #numberGrid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .num {
      padding: 12px;
      background: #222;
      border: 2px solid #555;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    .num.selected {
      background: #ffe066;
      border-color: #fff2a8;
      color: black;
    }
    .num.hit {
      background: #00ff44;
      border-color: #77ffb3;
      color: black;
      box-shadow: 0 0 10px #33ff77;
    }
    button {
      padding: 12px 25px;
      border: none;
      background: #ffcc00;
      color: black;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      margin: 10px;
      font-weight: bold;
    }
    #results {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      font-size: 17px;
    }
    .lb-item {
      background: rgba(255,255,255,0.07);
      padding: 10px;
      margin: 4px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 17px;
    }
  </style>

</head>

<body>

<script>
// redirect if not coming from login
if (!localStorage.getItem("username") || !localStorage.getItem("entryAmount")) {
    window.location.href = "login.html";
}
</script>

  <h1>Zii Game üéØ</h1>
  <p>Select up to 5 numbers and press Play</p>

  <div id="numberGrid"></div>

  <button id="playBtn">Play</button>
  <button id="leaderboardBtn">Leaderboard</button>

  <div id="results">Results will appear here.</div>

  <h2>üèÜ Leaderboard</h2>
  <div id="leaderboardList"></div>

<script>
// ------------------------------
// Supabase Init
// ------------------------------
const supabaseClient = supabase.createClient(
  "https://vdhuexwgplylprgpddoq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkaHVleHdncGx5bHByZ3BkZG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzI3MzgsImV4cCI6MjA4MDE0ODczOH0.oAtftTGawGDSTSpvzZQY_TCjn494tGQ2dn6nGwlzYfc"
);

// ------------------------------
// Load username + entry
// ------------------------------
const username = localStorage.getItem("username") || "Guest";
const entryAmount = Number(localStorage.getItem("entryAmount") || 10);

// ------------------------------
// Build Grid
// ------------------------------
let selected = [];
const maxPick = 5;

const grid = document.getElementById("numberGrid");
for (let i = 1; i <= 100; i++) {
  const div = document.createElement("div");
  div.className = "num";
  div.innerText = i;

  div.onclick = () => {
    if (selected.includes(i)) {
      selected = selected.filter(n => n !== i);
      div.classList.remove("selected");
    } else {
      if (selected.length >= maxPick) return;
      selected.push(i);
      div.classList.add("selected");
    }
  };

  grid.appendChild(div);
}

// Confetti
function confettiBurst() {
  for (let i = 0; i < 20; i++) {
    const e = document.createElement("div");
    e.style.position = "fixed";
    e.style.left = Math.random() * 100 + "vw";
    e.style.top = "-20px";
    e.style.width = "10px";
    e.style.height = "10px";
    e.style.background = `hsl(${Math.random()*360},100%,50%)`;
    e.style.borderRadius = "50%";
    e.style.animation = "fall 1.5s linear forwards";
    document.body.appendChild(e);
    setTimeout(() => e.remove(), 2000);
  }
}

// Play button
document.getElementById("playBtn").onclick = async () => {
  if (selected.length === 0) {
    alert("Pick at least 1 number!");
    return;
  }

  // Draw 20 numbers
  const drawn = [];
  while (drawn.length < 20) {
    let n = Math.floor(Math.random() * 100) + 1;
    if (!drawn.includes(n)) drawn.push(n);
  }

  // Hits
  const hits = selected.filter(n => drawn.includes(n));
  const points = hits.length * entryAmount;

  // Visual hits
  document.querySelectorAll(".num").forEach(x => x.classList.remove("hit"));
  hits.forEach(n => {
    const box = [...document.querySelectorAll(".num")]
      .find(el => Number(el.innerText) === n);
    if (box) box.classList.add("hit");
  });

  if (hits.length > 0) confettiBurst();

  document.getElementById("results").innerHTML = `
    üéØ Drawn: ${drawn.join(", ")}<br>
    ‚úî Hits: <b>${hits.length}</b><br>
    ‚≠ê Points Earned: <b>${points}</b>
  `;

  // Save to leaderboard
  await supabaseClient.from("leaderboard").insert([
    { username, score: points }
  ]);
};

// Leaderboard
document.getElementById("leaderboardBtn").onclick = async () => {
  const list = document.getElementById("leaderboardList");

  const { data } = await supabaseClient
    .from("leaderboard")
    .select("*")
    .order("score", { ascending: false })
    .limit(20);

  list.innerHTML = "";

  if (!data || data.length === 0) {
    list.innerHTML = "<i>No scores yet.</i>";
    return;
  }

  data.forEach((p, i) => {
    const medal = i === 0 ? "ü•á" :
                  i === 1 ? "ü•à" :
                  i === 2 ? "ü•â" : "";

    const div = document.createElement("div");
    div.className = "lb-item";
    div.innerHTML = `
      <span>${medal} #${i+1}</span>
      <span>${p.username}</span>
      <span>${p.score}</span>
    `;
    list.appendChild(div);
  });
};

</script>

</body>
</html>
