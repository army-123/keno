<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zii Game — Multiplayer (Final)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
    body {
        background: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
    }
    .lobby-box {
        width: 80%;
        margin: auto;
        margin-top: 40px;
        background: #111;
        padding: 20px;
        border-radius: 12px;
    }
    .player-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 20px;
        border-bottom: 1px solid #222;
    }
    .grid {
        width: 80%;
        margin: auto;
        margin-top: 30px;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
    }
    .num {
        padding: 15px;
        background: #222;
        border-radius: 8px;
        cursor: pointer;
    }
    .num.active {
        background: #ffc000;
        color: #000;
        font-weight: bold;
    }
    button {
        padding: 12px 20px;
        background: #ffc000;
        color: #000;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
    }
</style>
</head>

<body>

<h1>Zii Game — Multiplayer (Final)</h1>

<div class="lobby-box" id="lobbyBox">
    <h2>Public Lobby</h2>
    <div id="playersList"></div>

    <button onclick="leaveLobby()">Leave Lobby</button>
    <button onclick="submitNumbers()">Submit 5 Numbers</button>

    <h3 style="margin-top:20px;">Lobby Status</h3>
    <div id="statusBox">
        Players: <span id="playerCount"></span><br>
        Countdown: <span id="countdownDisplay">—</span><br>
        Status: <span id="lobbyStatus">waiting</span><br>
        Host: <span id="hostUser"></span><br>
    </div>
</div>

<h3>Pick up to 5 numbers</h3>
<div class="grid" id="numbersGrid"></div>

<div id="resultsBox" style="margin-top:40px; font-size:22px; color:#0f0;"></div>

<script>
/* -----------------------------------------------------------
   INIT SUPABASE
------------------------------------------------------------- */

const SUPABASE_URL = "https://vdhuexwgplylprgpddoq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkaHVleHdncGx5bHByZ3BkZG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzI3MzgsImV4cCI6MjA4MDE0ODczOH0.oAtftTGawGDSTSpvzZQY_TCjn494tGQ2dn6nGwlzYfc";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let username = "player_" + Math.floor(Math.random() * 999999);
let picked = [];

/* -----------------------------------------------------------
   UI SETUP
------------------------------------------------------------- */

function buildGrid() {
    const grid = document.getElementById("numbersGrid");
    for (let i = 1; i <= 60; i++) {
        let b = document.createElement("div");
        b.className = "num";
        b.innerText = i;
        b.onclick = () => selectNum(i, b);
        grid.appendChild(b);
    }
}
buildGrid();

/* PICK NUMBER */
function selectNum(n, el) {
    if (picked.includes(n)) {
        picked = picked.filter(x => x !== n);
        el.classList.remove("active");
    } else {
        if (picked.length >= 5) return;
        picked.push(n);
        el.classList.add("active");
    }
}

/* -----------------------------------------------------------
   SUBMIT PICKS
------------------------------------------------------------- */

async function submitNumbers() {
    if (picked.length !== 5) {
        alert("Pick exactly 5 numbers!");
        return;
    }

    // set ready=true
    await supabase
        .from("players")
        .update({ picks: picked, ready: true })
        .eq("username", username);

    alert("Submitted!");
}

/* -----------------------------------------------------------
   LEAVE LOBBY
------------------------------------------------------------- */

async function leaveLobby() {
    await supabase.from("players").delete().eq("username", username);
    location.reload();
}

/* -----------------------------------------------------------
   LISTEN FOR CHANGES
------------------------------------------------------------- */

supabase
    .channel("game_state")
    .on("postgres_changes", { event: "*", schema: "public", table: "game_state" }, payload => {
        loadGameState();
    })
    .subscribe();

supabase
    .channel("players")
    .on("postgres_changes", { event: "*", schema: "public", table: "players" }, payload => {
        loadPlayers();
    })
    .subscribe();

/* -----------------------------------------------------------
   LOAD PLAYERS
------------------------------------------------------------- */

async function loadPlayers() {
    let { data } = await supabase
        .from("players")
        .select("*");

    const box = document.getElementById("playersList");
    box.innerHTML = "";

    data.forEach(p => {
        box.innerHTML += `
            <div class="player-row">
                <div>${p.username}<br><small>amt: ${p.entry_amount || 10}</small></div>
                <div>${p.ready ? "<span style='color:#0f0'>SUBMITTED</span>" : "<span style='color:#aaa'>Not ready</span>"}</div>
            </div>
        `;
    });

    document.getElementById("playerCount").innerText = data.length;
}

/* -----------------------------------------------------------
   LOAD GAME STATE
------------------------------------------------------------- */

async function loadGameState() {
    let { data } = await supabase
        .from("game_state")
        .select("*");

    if (!data || data.length === 0) return;

    let g = data[0];

    document.getElementById("lobbyStatus").innerText = g.status;
    document.getElementById("countdownDisplay").innerText = g.countdown ?? "—";
    document.getElementById("hostUser").innerText = g.host_user;
    
    /* SHOW RESULTS */
    if (g.status === "finished") {
        document.getElementById("resultsBox").innerHTML =
            "<br>Drawn Numbers:<br><b>" + g.drawn_numbers.join(", ") + "</b><br><br>" +
            "Winners:<br><b>" + JSON.stringify(g.round_winners) + "</b>";

        return;
    }
}

/* -----------------------------------------------------------
   JOIN PLAYER AUTOMATICALLY
------------------------------------------------------------- */

async function joinPlayer() {
    await supabase
        .from("players")
        .insert([{ username, picks: [], ready: false }]);
}
joinPlayer();

/* -----------------------------------------------------------
   AUTO START CHECK LOOP
------------------------------------------------------------- */

setInterval(async () => {
    let { data: players } = await supabase.from("players").select("*");
    let { data: gs } = await supabase.from("game_state").select("*");

    if (!players || players.length < 2) return;

    let allReady = players.filter(p => p.ready).length >= 2;
    let g = gs[0];

    if (g.status === "waiting" && allReady) {
        startCountdown();
    }
}, 3000);

/* -----------------------------------------------------------
   START COUNTDOWN
------------------------------------------------------------- */

async function startCountdown() {
    await supabase
        .from("game_state")
        .update({
            status: "countdown",
            countdown: 60,
            round_started_at: new Date().toISOString()
        })
        .eq("room", "public");
}

/* -----------------------------------------------------------
   COUNTDOWN LOOP (HOST ONLY)
------------------------------------------------------------- */

setInterval(async () => {
    let { data } = await supabase.from("game_state").select("*");
    let g = data[0];

    if (g.status !== "countdown") return;

    // HOST is first player in list
    let { data: players } = await supabase.from("players").select("*");

    if (!players || players.length === 0) return;

    let host = players[0].username;
    if (username !== host) return;

    let now = Date.now();
    let start = new Date(g.round_started_at).getTime();
    let diff = Math.floor((now - start) / 1000);
    let left = 60 - diff;

    if (left < 0) left = 0;

    await supabase
        .from("game_state")
        .update({ countdown: left })
        .eq("room", "public");

    if (left === 0) {
        finishRound();
    }
}, 1000);

/* -----------------------------------------------------------
   FINISH ROUND → DRAW NUMBERS + FIND WINNERS
------------------------------------------------------------- */

async function finishRound() {
    let draw = [];

    while (draw.length < 20) {
        let n = Math.floor(Math.random() * 60) + 1;
        if (!draw.includes(n)) draw.push(n);
    }

    let { data: players } = await supabase.from("players").select("*");

    let winners = [];

    players.forEach(p => {
        let matches = p.picks.filter(v => draw.includes(v));
        if (matches.length >= 3) {
            winners.push({ user: p.username, matched: matches.length });
        }
    });

    await supabase
        .from("game_state")
        .update({
            status: "finished",
            drawn_numbers: draw,
            round_winners: winners,
            round_finished_at: new Date().toISOString()
        })
        .eq("room", "public");

    // Reset after 12 seconds
    setTimeout(resetLobby, 12000);
}

/* -----------------------------------------------------------
   RESET LOBBY
------------------------------------------------------------- */

async function resetLobby() {
    await supabase
        .from("players")
        .update({ ready: false, picks: [] });

    await supabase
        .from("game_state")
        .update({
            status: "waiting",
            countdown: null,
            drawn_numbers: [],
            round_winners: []
        })
        .eq("room", "public");
}

</script>

</body>
</html>
